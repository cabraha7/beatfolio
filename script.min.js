class AudioPlayer{constructor(){this.currentAudio=null,this.currentTrack=null,this.audioContext=null,this.analyser=null,this.dataArray=null,this.animationId=null,this.waveformData=new Map,this.trackColors=new Map,this.isDragging=!1,this.rainEffect=new RainEffect,this.lightningEffect=new LightningEffect,this.realtimeAnalysers=new Map,this.init()}async init(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(t){console.warn("Web Audio API not supported")}this.setupEventListeners(),this.generateTrackColors(),await this.preloadWaveforms()}generateTrackColors(){const t=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9","#FFFF00","#ADFF2F","#00FF00","#FFD700","#FFA500","#E6E6FA","#DA70D6","#BA55D3","#9370DB","#FF69B4","#FF1493","#DC143C","#B22222","#8B0000","#00CED1","#40E0D0","#48D1CC","#00FFFF","#7FFFD4","#98FB98","#90EE90","#32CD32","#228B22","#006400"];new Set;document.querySelectorAll(".track").forEach((e,i)=>{const a=e.dataset.src;let n;n=i<t.length?t[i]:t[i%t.length],this.trackColors.set(a,n)})}setupEventListeners(){document.querySelectorAll(".track").forEach(t=>{const e=t.querySelector(".play-button"),i=t.querySelector(".waveform");e.addEventListener("click",e=>{e.stopPropagation(),this.toggleTrack(t)}),i.addEventListener("click",e=>{if(this.currentTrack===t&&this.currentAudio){const t=i.getBoundingClientRect(),a=(e.clientX-t.left)/t.width*this.currentAudio.duration;this.currentAudio.currentTime=a}}),i.addEventListener("mousedown",e=>{this.currentTrack===t&&this.currentAudio&&(this.isDragging=!0,this.handleScrub(e,i))}),i.addEventListener("mousemove",e=>{this.isDragging&&this.currentTrack===t&&this.currentAudio&&this.handleScrub(e,i)}),i.addEventListener("mouseup",()=>{this.isDragging=!1}),i.addEventListener("mouseleave",()=>{this.isDragging=!1}),i.addEventListener("touchstart",e=>{e.preventDefault(),this.currentTrack===t&&this.currentAudio&&(this.isDragging=!0,this.handleTouchScrub(e,i))}),i.addEventListener("touchmove",e=>{e.preventDefault(),this.isDragging&&this.currentTrack===t&&this.currentAudio&&this.handleTouchScrub(e,i)}),i.addEventListener("touchend",t=>{t.preventDefault(),this.isDragging=!1}),i.addEventListener("touchcancel",t=>{t.preventDefault(),this.isDragging=!1}),i.style.cursor="pointer"})}handleScrub(t,e){const i=e.getBoundingClientRect(),a=t.clientX-i.left,n=Math.max(0,Math.min(1,a/i.width))*this.currentAudio.duration;this.currentAudio.currentTime=n}handleTouchScrub(t,e){const i=e.getBoundingClientRect(),a=(t.touches[0]||t.changedTouches[0]).clientX-i.left,n=Math.max(0,Math.min(1,a/i.width))*this.currentAudio.duration;this.currentAudio.currentTime=n}async preloadWaveforms(){const t=document.querySelectorAll(".track");for(const e of t){const t=e.dataset.src,i=e.querySelector(".waveform");try{const e=await this.generateWaveform(t);this.waveformData.set(t,e),setTimeout(()=>{this.drawStaticWaveform(i,e,t)},10)}catch(e){console.error(`Failed to generate waveform for ${t}:`,e),this.drawPlaceholderWaveform(i,t)}}}async generateWaveform(t){try{const e=await fetch(t),i=await e.arrayBuffer(),a=(await this.audioContext.decodeAudioData(i)).getChannelData(0),n=400,s=Math.floor(a.length/n),r=[];for(let t=0;t<n;t++){let e=s*t,i=0,n=0,o=0;for(let t=0;t<s;t++){const s=a[e+t],r=Math.abs(s);i+=r,n=Math.max(n,r),o+=s*s}const h=i/s,c=n,d=Math.sqrt(o/s),l=.4*h+.3*c+.3*d;r.push({average:h,peak:c,rms:d,combined:l})}const o=r.map(t=>t.combined),h=Math.max(...o),c=o.reduce((t,e)=>t+e,0)/o.length,d=.3*c,l=.7;return r.map(t=>{let e=t.combined;if(e<d)e=d+e/d*.2;else if(e>c){e=c+(e-c)*l}const i=.2+e/h*.7;return{average:Math.min(.85,Math.max(.15,t.average/h*.7+.15)),peak:Math.min(.9,Math.max(.2,t.peak/h*.7+.2)),rms:Math.min(.8,Math.max(.1,t.rms/h*.7+.1)),combined:Math.min(.95,Math.max(.2,i))}})}catch(t){return console.error("Error generating waveform:",t),this.generatePlaceholderData()}}generatePlaceholderData(){const t=[];for(let e=0;e<400;e++){const i=.15+.1*Math.sin(.1*e),a=.3*(Math.random()-.5),n=Math.random()>.9?.4*Math.random():0,s=Math.max(.05,Math.min(.9,i+a+n));t.push({average:.8*s,peak:s,rms:.9*s,combined:s})}return t}drawStaticWaveform(t,e,i){const a=t.getContext("2d"),n=this.trackColors.get(i)||"#2ECC71",s=t.getBoundingClientRect(),r=s.width,o=s.height;a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high";const h=window.devicePixelRatio||1;t.width=r*h,t.height=o*h,a.scale(h,h),a.clearRect(0,0,r,o);const c=o/2,d=e.length,l=r/d,u=Math.max(.5,.15*l);for(let t=0;t<d;t++){const i="object"==typeof e[t]?e[t].combined:e[t],s=Math.max(.3,Math.min(.95,i))*o*.85,r=t*l,h=Math.max(1,l-u),d=a.createLinearGradient(r,c-s/2,r,c+s/2);d.addColorStop(0,n+"CC"),d.addColorStop(.5,n+"99"),d.addColorStop(1,n+"CC"),a.fillStyle=d;const g=c-s/2,m=Math.min(h/3,2);a.beginPath(),a.roundRect(r,g,h,s,m),a.fill(),a.strokeStyle=n+"40",a.lineWidth=.5,a.stroke()}}drawAnimatedWaveform(t,e,i=0,a){const n=t.getContext("2d"),s=this.trackColors.get(a)||"#2ECC71",r=this.darkenColor(s,.3),o=t.getBoundingClientRect(),h=o.width,c=o.height;n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high";const d=window.devicePixelRatio||1;t.width=h*d,t.height=c*d,n.scale(d,d),n.clearRect(0,0,h,c);const l=c/2,u=h/(e.length-1),g=Math.floor(i*e.length);if(n.lineWidth=2,n.lineCap="round",n.lineJoin="round",g>0){n.strokeStyle=r,n.beginPath(),n.moveTo(0,l);for(let t=0;t<=g&&t<e.length;t++){const i=t*u,a=l-("object"==typeof e[t]?e[t].combined:e[t])*c*.4;n.lineTo(i,a)}n.stroke(),n.beginPath(),n.moveTo(0,l);for(let t=0;t<=g&&t<e.length;t++){const i=t*u,a=l+("object"==typeof e[t]?e[t].combined:e[t])*c*.4;n.lineTo(i,a)}n.stroke()}if(g<e.length-1){n.strokeStyle=s,n.beginPath();const t=g*u;n.moveTo(t,l);for(let t=g;t<e.length;t++){const i=t*u,a=l-("object"==typeof e[t]?e[t].combined:e[t])*c*.4;n.lineTo(i,a)}n.stroke(),n.beginPath(),n.moveTo(t,l);for(let t=g;t<e.length;t++){const i=t*u,a=l+("object"==typeof e[t]?e[t].combined:e[t])*c*.4;n.lineTo(i,a)}n.stroke()}const m=i*h;n.strokeStyle="#FF3B30",n.lineWidth=2,n.beginPath(),n.moveTo(m,0),n.lineTo(m,c),n.stroke()}darkenColor(t,e){const i=t.replace("#",""),a=Math.max(0,parseInt(i.substr(0,2),16)-Math.round(255*e)),n=Math.max(0,parseInt(i.substr(2,2),16)-Math.round(255*e)),s=Math.max(0,parseInt(i.substr(4,2),16)-Math.round(255*e));return`#${a.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`}drawPlaceholderWaveform(t,e){const i=this.generatePlaceholderData();this.drawStaticWaveform(t,i,e)}async toggleTrack(t){const e=t.dataset.src,i=t.querySelector(".play-button"),a=t.querySelector(".waveform");if(this.currentTrack!==t||!this.currentAudio||this.currentAudio.paused)if(this.currentTrack===t&&this.currentAudio&&this.currentAudio.paused)this.resumeTrack();else{this.currentAudio&&this.stopTrack();try{if(this.currentAudio=new Audio(e),this.currentTrack=t,this.audioContext&&"suspended"===this.audioContext.state&&await this.audioContext.resume(),this.audioContext){const t=this.audioContext.createMediaElementSource(this.currentAudio),i=this.audioContext.createAnalyser();i.fftSize=128,i.smoothingTimeConstant=.8,t.connect(i),i.connect(this.audioContext.destination),this.realtimeAnalysers.set(e,{analyser:i,dataArray:new Uint8Array(i.frequencyBinCount)})}t.classList.add("playing"),i.textContent="⏸",i.classList.add("playing"),await this.currentAudio.play(),this.audioContext&&this.realtimeAnalysers.has(e)&&this.startReactiveVisualization(a,e),this.currentAudio.addEventListener("timeupdate",()=>{if(this.currentAudio){const t=this.currentAudio.currentTime/this.currentAudio.duration,i=this.waveformData.get(e);if(i){this.drawAnimatedWaveform(a,i,t,e);const n=Math.floor(t*i.length);if(n<i.length){const t="object"==typeof i[n]?i[n].combined:i[n];if(this.rainEffect.updateIntensity(t),n>0){t-("object"==typeof i[n-1]?i[n-1].combined:i[n-1])>.4&&t>.8&&Math.random()>.8&&this.lightningEffect.trigger()}}}}}),this.currentAudio.addEventListener("ended",()=>{this.resetTrack(t)}),this.currentAudio.addEventListener("pause",()=>{if(this.currentTrack===t){t.classList.remove("playing"),i.textContent="▶",i.classList.remove("playing"),this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null);const n=this.waveformData.get(e);n&&this.drawStaticWaveform(a,n,e)}})}catch(e){console.error("Error playing audio:",e),this.resetTrack(t)}}else this.pauseTrack()}pauseTrack(){this.currentAudio&&this.currentAudio.pause()}resumeTrack(){if(this.currentAudio&&this.currentTrack){const t=this.currentTrack.querySelector(".waveform"),e=this.currentTrack.dataset.src;this.currentAudio.play(),this.realtimeAnalysers.has(e)&&this.startReactiveVisualization(t,e)}}stopTrack(){this.currentAudio&&(this.currentAudio.pause(),this.currentAudio.currentTime=0),this.currentTrack&&this.resetTrack(this.currentTrack),this.rainEffect.stop(),this.lightningEffect.stop()}resetTrack(t){const e=t.querySelector(".play-button"),i=t.querySelector(".waveform"),a=t.dataset.src;t.classList.remove("playing"),e.textContent="▶",e.classList.remove("playing");const n=this.waveformData.get(a);n&&this.drawStaticWaveform(i,n,a),this.currentTrack===t&&(this.currentTrack=null,this.currentAudio=null,this.rainEffect.stop(),this.lightningEffect.stop(),this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null))}startReactiveVisualization(t,e){t.getContext("2d");const i=this.realtimeAnalysers.get(e);if(!i)return;const a=()=>{this.currentAudio&&!this.currentAudio.paused&&this.currentTrack&&(i.analyser.getByteFrequencyData(i.dataArray),this.drawReactiveBarVisualizer(t,i.dataArray,e),this.animationId=requestAnimationFrame(a))};a()}drawReactiveBarVisualizer(t,e,i){const a=t.getContext("2d"),n=t.width,s=t.height,r=this.trackColors.get(i)||"#2ECC71";a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high";const o=window.devicePixelRatio||1;if(1!==o){const e=t.getBoundingClientRect();t.width=e.width*o,t.height=e.height*o,a.scale(o,o)}a.clearRect(0,0,n/o,s/o);const h=s/o/2,c=n/o/64,d=Math.floor(e.length/64),l=a.createLinearGradient(0,0,0,s/o);l.addColorStop(0,r),l.addColorStop(.5,this.lightenColor(r,.2)),l.addColorStop(1,r),a.fillStyle=l,a.shadowColor=r,a.shadowBlur=2,a.shadowOffsetY=1;for(let t=0;t<64;t++){const i=e[t*d]/255*(s/o)*.8,n=t*c,r=h-i/2,l=Math.max(2,.95*c),u=n+(c-l)/2;a.roundRect?(a.beginPath(),a.roundRect(u,r,l,i,2),a.fill()):a.fillRect(u,r,l,i)}a.shadowColor="transparent",a.shadowBlur=0,a.shadowOffsetY=0;const u=e.reduce((t,e)=>t+e,0)/e.length/255;this.rainEffect.updateIntensity(u);const g=e.slice(0,8);g.reduce((t,e)=>t+e,0)/g.length>180&&Math.random()>.7&&this.lightningEffect.trigger()}lightenColor(t,e){const i=t.replace("#",""),a=Math.min(255,parseInt(i.substr(0,2),16)+Math.round(255*e)),n=Math.min(255,parseInt(i.substr(2,2),16)+Math.round(255*e)),s=Math.min(255,parseInt(i.substr(4,2),16)+Math.round(255*e));return`#${a.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`}}class RainEffect{constructor(){this.canvas=null,this.ctx=null,this.raindrops=[],this.animationId=null,this.intensity=0,this.isActive=!1,this.init()}init(){this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="-1",this.canvas.style.opacity="0.6",document.body.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}updateIntensity(t){this.intensity=t,!this.isActive&&t>.1?this.start():this.isActive&&t<.05&&this.stop();const e=Math.floor(25*t);for(let t=0;t<e;t++)this.addRaindrop()}addRaindrop(){this.raindrops.push({x:Math.random()*this.canvas.width,y:-20,speed:4+6*Math.random()+4*this.intensity,length:15+30*Math.random(),opacity:.4+.5*Math.random(),thickness:1+2*Math.random()})}start(){this.isActive||(this.isActive=!0,this.animate())}stop(){this.isActive=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.raindrops=[],this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}animate(){this.isActive&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.raindrops=this.raindrops.filter(t=>(t.y+=t.speed,!(t.y>this.canvas.height+t.length)&&(this.ctx.strokeStyle=`rgba(200, 200, 255, ${t.opacity})`,this.ctx.lineWidth=t.thickness,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(t.x,t.y+t.length),this.ctx.stroke(),!0))),this.animationId=requestAnimationFrame(()=>this.animate()))}}class LightningEffect{constructor(){this.canvas=null,this.ctx=null,this.isActive=!1,this.animationId=null,this.init()}init(){this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none",this.canvas.style.zIndex="-1",document.body.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}trigger(){if(this.isActive)return;this.isActive=!0,this.drawLightning(),document.body.style.transition="background-color 0.1s";const t=document.body.style.backgroundColor;document.body.style.backgroundColor="rgba(255, 255, 255, 0.1)",setTimeout(()=>{document.body.style.backgroundColor=t,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.isActive=!1},150)}drawLightning(){const t=Math.random()*this.canvas.width,e=t+200*(Math.random()-.5),i=this.canvas.height;this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=3,this.ctx.shadowBlur=10,this.ctx.shadowColor="#FFFFFF",this.drawLightningBolt(t,0,e,i,.8);const a=(t+e)/2,n=this.canvas.height/2;this.ctx.lineWidth=2,this.drawLightningBolt(a,n,a+100*(Math.random()-.5),n+100,.5),this.drawLightningBolt(a,n,a+100*(Math.random()-.5),n+100,.5)}drawLightningBolt(t,e,i,a,n){const s=40*n;this.ctx.beginPath(),this.ctx.moveTo(t,e);for(let n=1;n<=20;n++){const r=n/20,o=t+(i-t)*r+(Math.random()-.5)*s,h=e+(a-e)*r;this.ctx.lineTo(o,h)}this.ctx.stroke()}stop(){this.isActive=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}}document.addEventListener("DOMContentLoaded",()=>{new AudioPlayer});